package com.v2ray.ang.handlerimport android.content.Contextimport android.os.SystemClockimport android.util.Logimport com.v2ray.ang.AppConfigimport com.v2ray.ang.dto.EConfigTypeimport com.v2ray.ang.dto.ProfileItemimport com.v2ray.ang.fmt.Hysteria2Fmtimport com.v2ray.ang.service.ProcessServiceimport com.v2ray.ang.util.JsonUtilimport com.v2ray.ang.util.Utilsimport kotlinx.coroutines.delayimport kotlinx.coroutines.sync.Muteximport kotlinx.coroutines.sync.withLockimport java.io.Fileobject PluginServiceManager {    private const val HYSTERIA2 = "libhysteria2.so"    private val procService: ProcessService by lazy {        ProcessService()    }    private val hy2PingMutex = Mutex()    @Volatile var lastHy2Error: String = ""    fun runPlugin(context: Context, config: ProfileItem?, socksPort: Int?) {        Log.i(AppConfig.TAG, "Starting plugin execution")        if (config == null) {            Log.w(AppConfig.TAG, "Cannot run plugin: config is null")            return        }        try {            if (config.configType == EConfigType.HYSTERIA2) {                if (socksPort == null) {                    Log.w(AppConfig.TAG, "Cannot run plugin: socksPort is null")                    return                }                Log.i(AppConfig.TAG, "Running Hysteria2 plugin")                val configFile = genConfigHy2(context, config, socksPort) ?: return                val cmd = genCmdHy2(context, configFile)                procService.runProcess(context, cmd)            }        } catch (e: Exception) {            Log.e(AppConfig.TAG, "Error running plugin", e)        }    }    fun stopPlugin() {        stopHy2()    }    suspend fun realPingHy2(context: Context, config: ProfileItem?): Long {        val retFailure = -1L        lastHy2Error = ""        if (config?.configType != EConfigType.HYSTERIA2) {            lastHy2Error = "非HY2协议"            return retFailure        }        return hy2PingMutex.withLock {            try {                val socksPort = Utils.findFreePort(listOf(0))                lastHy2Error = "端口=$socksPort"                val hy2Config = Hysteria2Fmt.toNativeConfig(config, socksPort)                if (hy2Config == null) {                    lastHy2Error = "toNativeConfig返回null"                    return@withLock retFailure                }                val configFile = File(context.noBackupFilesDir, "hy2_ping_${java.util.UUID.randomUUID()}.json")                configFile.parentFile?.mkdirs()                val configJson = JsonUtil.toJson(hy2Config)                configFile.writeText(configJson)                lastHy2Error = "配置已写入,端口=$socksPort"                val hy2Binary = File(context.applicationInfo.nativeLibraryDir, HYSTERIA2)                if (!hy2Binary.exists()) {                    lastHy2Error = "libhysteria2.so不存在: ${hy2Binary.absolutePath}"                    configFile.delete()                    return@withLock retFailure                }                lastHy2Error = "so存在,启动进程..."                val cmd = genCmdHy2(context, configFile)                val proc = ProcessService()                proc.runProcess(context, cmd)                delay(2000L)                lastHy2Error = "进程已启动,等待2s完毕"                val socksConfigJson = """                {                  "outbounds": [                    {                      "tag": "proxy",                      "protocol": "socks",                      "settings": {                        "servers": [                          {                            "address": "127.0.0.1",                            "port": $socksPort                          }                        ]                      }                    }                  ]                }                """.trimIndent()                lastHy2Error = "开始measureOutboundDelay..."                val testUrl = SettingsManager.getDelayTestUrl()                val elapsed = V2RayNativeManager.measureOutboundDelay(socksConfigJson, testUrl)                lastHy2Error = "测速结果=${elapsed}ms (url=$testUrl)"                proc.stopProcess()                try { configFile.delete() } catch (_: Exception) {}                return@withLock elapsed            } catch (e: Exception) {                lastHy2Error = "异常: ${e.javaClass.simpleName}: ${e.message}"                return@withLock retFailure            }        }    }    private fun genConfigHy2(context: Context, config: ProfileItem, socksPort: Int): File? {        Log.i(AppConfig.TAG, "runPlugin $HYSTERIA2")        val hy2Config = Hysteria2Fmt.toNativeConfig(config, socksPort) ?: return null        val configFile = File(context.noBackupFilesDir, "hy2_${SystemClock.elapsedRealtime()}.json")        Log.i(AppConfig.TAG, "runPlugin ${configFile.absolutePath}")        configFile.parentFile?.mkdirs()        configFile.writeText(JsonUtil.toJson(hy2Config))        Log.i(AppConfig.TAG, JsonUtil.toJson(hy2Config))        return configFile    }    private fun genCmdHy2(context: Context, configFile: File): MutableList<String> {        return mutableListOf(            File(context.applicationInfo.nativeLibraryDir, HYSTERIA2).absolutePath,            "--disable-update-check",            "--config",            configFile.absolutePath,            "--log-level",            "warn",            "client"        )    }    private fun stopHy2() {        try {            Log.i(AppConfig.TAG, "$HYSTERIA2 destroy")            procService?.stopProcess()        } catch (e: Exception) {            Log.e(AppConfig.TAG, "Failed to stop Hysteria2 process", e)        }    }}